<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>My Products - Smart Tourism Assistant</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
</head>
<body class="bg-gray-100">
    <!-- Navigation -->
    <nav class="bg-white shadow-lg fixed w-full top-0 z-50">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between items-center h-16">
                <div class="flex items-center">
                    <i class="fas fa-store text-2xl text-green-600 mr-2"></i>
                    <span class="text-xl font-bold text-gray-800">Smart Tourism Assistant</span>
                </div>
                <div class="hidden md:block">
                    <div class="ml-10 flex items-baseline space-x-4">
                        <a href="vendor-dashboard.html" class="text-gray-500 hover:text-green-600 px-3 py-2 rounded-md text-sm font-medium">Dashboard</a>
                        <a href="vendor-products.html" class="text-green-600 px-3 py-2 rounded-md text-sm font-medium">My Products</a>
                        <a href="vendor-orders.html" class="text-gray-500 hover:text-green-600 px-3 py-2 rounded-md text-sm font-medium">Orders</a>
                        <a href="vendor-profile.html" class="text-gray-500 hover:text-green-600 px-3 py-2 rounded-md text-sm font-medium">Profile</a>
                    </div>
                </div>
                <div class="md:hidden">
                    <button id="mobile-menu-button" class="text-gray-500 hover:text-gray-600 focus:outline-none focus:text-gray-600">
                        <i class="fas fa-bars text-xl"></i>
                    </button>
                </div>
            </div>
        </div>
        <!-- Mobile menu -->
        <div id="mobile-menu" class="md:hidden hidden bg-white border-t">
            <div class="px-2 pt-2 pb-3 space-y-1 sm:px-3">
                <a href="vendor-dashboard.html" class="text-gray-500 block px-3 py-2 rounded-md text-base font-medium">Dashboard</a>
                <a href="vendor-products.html" class="text-green-600 block px-3 py-2 rounded-md text-base font-medium">My Products</a>
                <a href="vendor-orders.html" class="text-gray-500 block px-3 py-2 rounded-md text-base font-medium">Orders</a>
                <a href="vendor-profile.html" class="text-gray-500 block px-3 py-2 rounded-md text-base font-medium">Profile</a>
        </div>
    </nav>

    <!-- Main Content -->
    <div class="pt-20 px-4 sm:px-6 lg:px-8">
            <header class="flex justify-between items-center mb-8">
                <h2 class="text-3xl font-bold text-gray-800">My Products</h2>
                <button onclick="showAddProductForm()" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg"><i class="fas fa-plus mr-2"></i>Add New Product</button>
            </header>

            <!-- Add Product Form (Hidden by default) -->
            <div id="add-product-form" class="hidden bg-white p-6 rounded-lg shadow-md mb-8">
                <h3 class="text-xl font-bold text-gray-800 mb-4">Add a New Product</h3>
                <form onsubmit="addProduct(event)">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div>
                            <label for="product-name" class="block text-gray-700 font-bold mb-2">Product Name</label>
                            <input type="text" id="product-name" class="w-full border rounded-lg py-2 px-3 text-gray-700" required>
                        </div>
                        <div>
                            <label for="product-category" class="block text-gray-700 font-bold mb-2">Category</label>
                            <select id="product-category" class="w-full border rounded-lg py-2 px-3 text-gray-700">
                                <option>Handicrafts</option>
                                <option>Spices</option>
                                <option>Textiles</option>
                                <option>Souvenirs</option>
                            </select>
                        </div>
                        <div class="md:col-span-2">
                            <label for="product-description" class="block text-gray-700 font-bold mb-2">Description</label>
                            <textarea id="product-description" rows="3" class="w-full border rounded-lg py-2 px-3 text-gray-700"></textarea>
                        </div>
                        <div>
                            <label for="product-price" class="block text-gray-700 font-bold mb-2">Price (₹)</label>
                            <input type="number" id="product-price" class="w-full border rounded-lg py-2 px-3 text-gray-700" required>
                        </div>
                        <div>
                            <label for="product-image" class="block text-gray-700 font-bold mb-2">Product Image</label>
                            <input type="file" id="product-image" class="w-full text-gray-700">
                        </div>
                    </div>
                    <div class="mt-6 flex justify-end gap-4">
                        <button type="button" onclick="hideAddProductForm()" class="bg-gray-300 hover:bg-gray-400 text-gray-800 font-bold py-2 px-4 rounded-lg">Cancel</button>
                        <button type="submit" class="bg-green-500 hover:bg-green-600 text-white font-bold py-2 px-4 rounded-lg">Save Product</button>
                    </div>
                </form>
            </div>
            <div id="success-message" class="hidden bg-green-100 border border-green-400 text-green-700 px-4 py-3 rounded relative mb-4" role="alert">
                <strong class="font-bold">Success!</strong>
                <span class="block sm:inline">New product has been added.</span>
            </div>

            <!-- Products Table -->
            <div class="bg-white p-6 rounded-lg shadow-md">
                <table class="w-full text-left">
                    <thead>
                        <tr class="border-b">
                            <th class="py-2">Image</th>
                            <th class="py-2">Name</th>
                            <th class="py-2">Price</th>
                            <th class="py-2">Stock</th>
                            <th class="py-2">Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr class="border-b">
                            <td class="py-3"><img src="https://via.placeholder.com/50x50.png?text=Pottery" alt="Product" class="w-12 h-12 object-cover rounded"></td>
                            <td class="py-3 font-medium">Handmade Pottery</td>
                            <td class="py-3">₹850</td>
                            <td class="py-3">25</td>
                            <td class="py-3">
                                <button class="text-blue-600 hover:text-blue-800 mr-2"><i class="fas fa-edit"></i></button>
                                <button class="text-red-600 hover:text-red-800"><i class="fas fa-trash"></i></button>
                            </td>
                        </tr>
                        <tr class="border-b">
                            <td class="py-3"><img src="https://via.placeholder.com/50x50.png?text=Scarf" alt="Product" class="w-12 h-12 object-cover rounded"></td>
                            <td class="py-3 font-medium">Silk Scarf</td>
                            <td class="py-3">₹1,200</td>
                            <td class="py-3">40</td>
                            <td class="py-3">
                                <button class="text-blue-600 hover:text-blue-800 mr-2"><i class="fas fa-edit"></i></button>
                                <button class="text-red-600 hover:text-red-800"><i class="fas fa-trash"></i></button>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </main>
    </div>
    <script>
/* ------------------------------------------
   GET LOGGED-IN VENDOR DETAILS
------------------------------------------ */
let vendor = JSON.parse(localStorage.getItem("vendor_user"));

if (!vendor) {
    alert("Please login again!");
    window.location.href = "vendor-login.html";
}

const vendor_id = vendor.id;


/* ------------------------------------------
   SHOW/HIDE ADD PRODUCT FORM
------------------------------------------ */
const addProductForm = document.getElementById('add-product-form');
const successMessage = document.getElementById('success-message');

function showAddProductForm() {
    addProductForm.classList.remove('hidden');
}

function hideAddProductForm() {
    addProductForm.classList.add('hidden');
}


/* ------------------------------------------
   LOAD PRODUCTS FROM BACKEND
------------------------------------------ */
async function loadProducts() {
    const tableBody = document.querySelector("table tbody");
    tableBody.innerHTML = `
        <tr><td colspan="5" class="py-4 text-center">Loading...</td></tr>
    `;

    try {
        const res = await fetch(`http://127.0.0.1:8000/api/products/${vendor_id}/`);
        const data = await res.json();

        tableBody.innerHTML = "";

        data.products.forEach(product => {
    tableBody.innerHTML += `
        <tr class="border-b">
            <td class="py-3">
                <img src="${product.image_url 
                            ? product.image_url 
                            : `http://127.0.0.1:8000${product.image}`}"
                     class="w-12 h-12 object-cover rounded">
            </td>
            <td class="py-3 font-medium">${product.name}</td>
            <td class="py-3">₹${product.price}</td>
            <td class="py-3">—</td>
            <td class="py-3">
                <button onclick="editProduct(${product.id})" class="text-blue-600 hover:text-blue-800 mr-2">
                    <i class="fas fa-edit"></i>
                </button>
                <button onclick="deleteProduct(${product.id})" class="text-red-600 hover:text-red-800">
                    <i class="fas fa-trash"></i>
                </button>
            </td>
        </tr>
    `;
});
    } catch (err) {
        tableBody.innerHTML = `
            <tr><td colspan="5" class="py-4 text-center text-red-600">Failed to load products</td></tr>
        `;
    }
}

loadProducts();


/* ------------------------------------------
   ADD NEW PRODUCT
------------------------------------------ */
async function addProduct(event) {
    event.preventDefault();   // <-- STOP PAGE RELOAD

    const formData = new FormData();
    formData.append("vendor_id", vendor.id);
    formData.append("name", document.getElementById("product-name").value);
    formData.append("category", document.getElementById("product-category").value);
    formData.append("description", document.getElementById("product-description").value);
    formData.append("price", document.getElementById("product-price").value);
    formData.append("stock", 20);
    formData.append("image", document.getElementById("product-image").files[0]);

    const res = await fetch("http://127.0.0.1:8000/api/products/add/", {
        method: "POST",
        body: formData
    });

    const data = await res.json();
    console.log("UPLOAD RESPONSE:", data);

    if (data.success) {
        alert("Product added!");
        hideAddProductForm();
        loadProducts();
    } else {
        alert("Failed to add product: " + data.message);
    }
}




/* ------------------------------------------
   EDIT PRODUCT
------------------------------------------ */
async function editProduct(productId) {

    const res = await fetch(`http://127.0.0.1:8000/api/products/${vendor_id}/`);
    const data = await res.json();

    const product = data.products.find(p => p.id === productId);

    if (!product) return alert("Product not found");

    const newName = prompt("New name:", product.name);
    const newDesc = prompt("New description:", product.description);
    const newPrice = prompt("New price:", product.price);
    const newCategory = prompt("New category:", product.category);

    if (!newName) return;

    const body = {
        name: newName,
        description: newDesc,
        price: newPrice,
        category: newCategory,
        image_url: product.image_url
    };

    const updateRes = await fetch(`http://127.0.0.1:8000/api/products/update/${productId}/`, {
        method: "PUT",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(body)
    });

    const updateData = await updateRes.json();

    alert(updateData.message);
    loadProducts();
}



/* ------------------------------------------
   DELETE PRODUCT
------------------------------------------ */
async function deleteProduct(productId) {
    if (!confirm("Delete this product?")) return;

    const res = await fetch(`http://127.0.0.1:8000/api/products/delete/${productId}/`, {
        method: "DELETE"
    });

    const data = await res.json();
    alert(data.message);

    loadProducts();
}


/* ------------------------------------------
   Mobile Menu
------------------------------------------ */
document.getElementById('mobile-menu-button').addEventListener('click', () => {
    document.getElementById('mobile-menu').classList.toggle('hidden');
});

</script>
</body>
</html>